{% extends "base.html" %}

{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-white mb-2">تأكيد الاشتراك</h2>
    <p class="text-gray-400">اختر السيارة والمنطقة المناسبة</p>
</div>

<!-- Package Summary -->
<div class="bg-purple-900 bg-opacity-30 border border-purple-600 rounded-lg p-6 mb-6">
    <div class="flex justify-between items-center mb-3">
        <h3 class="text-xl font-bold text-white">{{ package.name_ar }}</h3>
        <span class="text-2xl font-bold text-purple-300">{{ package.price }} ريال</span>
    </div>
    <div class="grid grid-cols-2 gap-4 text-sm">
        <div class="text-gray-300">
            <i class="fas fa-car-alt ml-2 text-purple-400"></i>
            <span>{{ package.wash_count }} غسلة</span>
        </div>
        <div class="text-gray-300">
            <i class="fas fa-calendar ml-2 text-purple-400"></i>
            <span>{{ package.duration_days }} يوم</span>
        </div>
    </div>
</div>

<!-- Subscription Form -->
<form method="POST" class="space-y-6">
    <!-- Vehicle Selection -->
    <div class="bg-primary rounded-lg p-6 shadow-lg">
        <h3 class="text-lg font-bold text-white mb-4">
            <i class="fas fa-car ml-2 text-accent"></i>اختر السيارة
        </h3>

        {% if vehicles %}
        <div class="space-y-3">
            {% for vehicle in vehicles %}
            <label class="flex items-center p-4 bg-darkbg rounded-lg cursor-pointer hover:bg-gray-700 transition">
                <input type="radio" name="vehicle_id" value="{{ vehicle.id }}" required
                    class="ml-3 w-5 h-5 text-purple-600">
                <div class="flex-1">
                    <p class="font-bold text-white">{{ vehicle.brand }}</p>
                    <p class="text-sm text-gray-400">{{ vehicle.plate_number }}</p>
                </div>
                <i class="fas fa-car text-gray-500 text-2xl"></i>
            </label>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded-lg p-4">
            <p class="text-yellow-300 mb-3">لا توجد مركبات مسجلة. يرجى إضافة مركبة أولاً.</p>
            <a href="{{ url_for('customer.add_vehicle') }}" class="text-accent hover:underline">
                <i class="fas fa-plus ml-1"></i>إضافة مركبة
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Location Selection -->
    <div class="bg-primary rounded-lg p-6 shadow-lg">
        <h3 class="text-lg font-bold text-white mb-4">
            <i class="fas fa-map-marker-alt ml-2 text-accent"></i>اختر المنطقة
        </h3>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">المدينة</label>
                <select id="city_select" name="city_id" required
                    class="w-full bg-darkbg border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-purple-600">
                    <option value="">-- اختر المدينة --</option>
                    {% for city in cities %}
                    <option value="{{ city.id }}">{{ city.name_ar }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">الحي</label>
                <select id="neighborhood_select" name="neighborhood_id" required
                    class="w-full bg-darkbg border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-purple-600">
                    <option value="">-- اختر المدينة أولاً --</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Preferred Time (Optional) -->
    <div class="bg-primary rounded-lg p-6 shadow-lg">
        <h3 class="text-lg font-bold text-white mb-4">
            <i class="fas fa-clock ml-2 text-accent"></i>الوقت المفضل (اختياري)
        </h3>
        <p class="text-sm text-gray-400 mb-3">يمكنك تحديد الوقت المفضل للغسيل، وسيتم التواصل معك لتأكيد المواعيد</p>

        <div class="grid grid-cols-2 gap-3">
            <label
                class="time-option flex items-center p-3 bg-darkbg rounded-lg cursor-pointer hover:bg-gray-700 transition border-2 border-transparent">
                <input type="radio" name="preferred_time" value="morning" class="ml-2">
                <div class="flex-1">
                    <i class="fas fa-sun text-yellow-400 ml-1"></i>
                    <span class="text-white">صباحاً</span>
                    <p class="text-xs text-gray-400">8 AM - 12 PM</p>
                </div>
            </label>
            <label
                class="time-option flex items-center p-3 bg-darkbg rounded-lg cursor-pointer hover:bg-gray-700 transition border-2 border-transparent">
                <input type="radio" name="preferred_time" value="afternoon" class="ml-2">
                <div class="flex-1">
                    <i class="fas fa-cloud-sun text-orange-400 ml-1"></i>
                    <span class="text-white">ظهراً</span>
                    <p class="text-xs text-gray-400">12 PM - 4 PM</p>
                </div>
            </label>
            <label
                class="time-option flex items-center p-3 bg-darkbg rounded-lg cursor-pointer hover:bg-gray-700 transition border-2 border-transparent">
                <input type="radio" name="preferred_time" value="evening" class="ml-2">
                <div class="flex-1">
                    <i class="fas fa-moon text-blue-400 ml-1"></i>
                    <span class="text-white">مساءً</span>
                    <p class="text-xs text-gray-400">4 PM - 8 PM</p>
                </div>
            </label>
            <label
                class="time-option flex items-center p-3 bg-darkbg rounded-lg cursor-pointer hover:bg-gray-700 transition border-2 border-accent">
                <input type="radio" name="preferred_time" value="flexible" class="ml-2" checked>
                <div class="flex-1">
                    <i class="fas fa-clock text-gray-400 ml-1"></i>
                    <span class="text-white">في أي وقت</span>
                    <p class="text-xs text-gray-400">مرن</p>
                </div>
            </label>
        </div>
    </div>

    <!-- Submit -->
    <div class="flex gap-3">
        <button type="submit" {% if not vehicles %}disabled{% endif %}
            class="flex-1 bg-accent hover:bg-blue-600 disabled:bg-gray-700 disabled:cursor-not-allowed text-white py-4 rounded-lg font-bold transition">
            <i class="fas fa-check ml-2"></i>إرسال طلب الاشتراك
        </button>
        <a href="{{ url_for('customer.subscribe_flow') }}"
            class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-4 rounded-lg font-bold transition">
            إلغاء
        </a>
    </div>
</form>

<script>
    // Dynamic neighborhood loading
    document.getElementById('city_select').addEventListener('change', function () {
        const cityId = this.value;
        const neighborhoodSelect = document.getElementById('neighborhood_select');

        neighborhoodSelect.innerHTML = '<option value="">جاري التحميل...</option>';

        if (!cityId) {
            neighborhoodSelect.innerHTML = '<option value="">-- اختر المدينة أولاً --</option>';
            return;
        }

        fetch(`/customer/api/neighborhoods/${cityId}`)
            .then(response => response.json())
            .then(neighborhoods => {
                neighborhoodSelect.innerHTML = '<option value="">-- اختر الحي --</option>';
                neighborhoods.forEach(n => {
                    const option = document.createElement('option');
                    option.value = n.id;
                    option.textContent = n.name;
                    neighborhoodSelect.appendChild(option);
                });
            });
    });

    // Visual feedback for time selection
    document.querySelectorAll('.time-option input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function () {
            // Remove accent border from all
            document.querySelectorAll('.time-option').forEach(label => {
                label.classList.remove('border-accent');
                label.classList.add('border-transparent');
            });
            // Add accent border to selected
            if (this.checked) {
                this.closest('.time-option').classList.remove('border-transparent');
                this.closest('.time-option').classList.add('border-accent');
            }
        });
    });
</script>
{% endblock %}