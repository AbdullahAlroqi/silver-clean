{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-8">
        <h2 class="text-3xl font-bold text-white">Ø­Ø¬ÙˆØ²Ø§ØªÙŠ</h2>
        <a href="{{ url_for('customer.index') }}"
            class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-bold transition">
            <i class="fas fa-arrow-right mr-2"></i>Ø±Ø¬ÙˆØ¹
        </a>
    </div>

    {% if bookings %}
    <div class="grid gap-4">
        {% for booking in bookings %}
        <div class="bg-primary p-6 rounded-lg shadow-lg border-r-4 
                {% if booking.status == 'completed' %}border-green-500
                {% elif booking.status == 'cancelled' %}border-red-500
                {% elif booking.status == 'in_progress' %}border-blue-500
                {% else %}border-accent{% endif %}">

            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-white mb-2">
                        <i class="fas fa-spray-can text-accent mr-2"></i>
                        {{ booking.service.name_ar }}
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-gray-300">
                        <div>
                            <i class="fas fa-calendar text-accent mr-2"></i>
                            <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ booking.date.strftime('%Y-%m-%d') }}
                        </div>
                        <div>
                            <i class="fas fa-clock text-accent mr-2"></i>
                            <strong>Ø§Ù„ÙˆÙ‚Øª:</strong> {{ booking.time.strftime('%H:%M') }}
                        </div>
                        <div>
                            <i class="fas fa-car text-accent mr-2"></i>
                            <strong>Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</strong> {{ booking.vehicle.brand }} - {{ booking.vehicle.plate_number }}
                        </div>
                        {% if booking.employee %}
                        <div>
                            <i class="fas fa-user text-accent mr-2"></i>
                            <strong>Ø§Ù„Ù…ÙˆØ¸Ù:</strong> {{ booking.employee.username }}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Discount/Free Wash Info -->
                    {% if booking.used_free_wash or booking.discount_code %}
                    <div
                        class="mt-4 p-3 bg-gradient-to-r from-blue-900/30 to-blue-800/20 border border-blue-500 rounded-lg">
                        {% if booking.used_free_wash %}
                        <div class="flex items-center gap-2 text-green-400 mb-2">
                            <i class="fas fa-gift"></i>
                            <span class="font-bold">ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ØºØ³Ù„Ø© Ù…Ø¬Ø§Ù†ÙŠØ© ğŸ</span>
                        </div>
                        {% endif %}
                        {% if booking.discount_code %}
                        <div class="flex items-center gap-2 text-blue-300">
                            <i class="fas fa-ticket-alt"></i>
                            <span class="font-bold">ÙƒÙˆØ¯ Ø®ØµÙ…: {{ booking.discount_code.code }}</span>
                            <span class="text-green-400">
                                ({% if booking.discount_code.discount_type == 'percentage' %}{{
                                booking.discount_code.value }}%{% else %}{{ booking.discount_code.value }} Ø±.Ø³{% endif
                                %})
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Price Breakdown -->
                    <div class="mt-4 p-4 bg-gray-800 rounded-lg">
                        {% set products_total = namespace(value=0) %}
                        {% for bp in booking.products %}
                        {% set products_total.value = products_total.value + (bp.product.price * bp.quantity) %}
                        {% endfor %}

                        {% set service_price = booking.service.price %}
                        {% set discount_amount = 0 %}

                        {% if booking.used_free_wash %}
                        {% set service_price = 0 %}
                        {% elif booking.discount_code %}
                        {% if booking.discount_code.discount_type == 'percentage' %}
                        {% set discount_amount = (service_price * booking.discount_code.value / 100) %}
                        {% else %}
                        {% set discount_amount = booking.discount_code.value %}
                        {% endif %}
                        {% endif %}

                        {% set grand_total = (service_price - discount_amount) + products_total.value %}

                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between text-gray-300">
                                <span><i class="fas fa-spray-can text-accent mr-2"></i>Ø³Ø¹Ø± Ø§Ù„Ø®Ø¯Ù…Ø©:</span>
                                <span class="font-bold">{% if booking.used_free_wash %}<span
                                        class="text-green-400">Ù…Ø¬Ø§Ù†Ø§Ù‹</span>{% else %}{{ booking.service.price }} Ø±ÙŠØ§Ù„{%
                                    endif %}</span>
                            </div>
                            {% if discount_amount > 0 %}
                            <div class="flex justify-between text-green-400">
                                <span><i class="fas fa-tag mr-2"></i>Ø§Ù„Ø®ØµÙ…:</span>
                                <span class="font-bold">- {{ "%.1f"|format(discount_amount) }} Ø±ÙŠØ§Ù„</span>
                            </div>
                            {% endif %}
                            {% if products_total.value > 0 %}
                            <div class="flex justify-between text-gray-300">
                                <span><i class="fas fa-shopping-cart mr-2"></i>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</span>
                                <span class="font-bold">{{ products_total.value }} Ø±ÙŠØ§Ù„</span>
                            </div>
                            {% endif %}
                            <div
                                class="flex justify-between text-accent font-bold text-lg border-t border-gray-700 pt-2 mt-2">
                                <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                                <span>{{ "%.1f"|format(grand_total) }} Ø±ÙŠØ§Ù„</span>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Products Details -->
                    {% if booking.products.count() > 0 %}
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <p class="text-sm font-bold text-accent mb-2">
                            <i class="fas fa-shopping-cart mr-2"></i>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©:
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            {% for bp in booking.products %}
                            <div class="text-sm text-gray-300 bg-gray-800 p-2 rounded">
                                â€¢ {{ bp.product.name_ar }} <span class="text-gray-400">(Ã— {{ bp.quantity }})</span> -
                                <span class="text-accent font-bold">{{ bp.product.price * bp.quantity }} Ø±ÙŠØ§Ù„</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="mr-4 text-center">
                    <span class="inline-block px-4 py-2 rounded-lg text-sm font-bold
                            {% if booking.status == 'pending' %}bg-yellow-600 text-white
                            {% elif booking.status == 'assigned' %}bg-blue-600 text-white
                            {% elif booking.status == 'en_route' %}bg-purple-600 text-white
                            {% elif booking.status == 'arrived' %}bg-indigo-600 text-white
                            {% elif booking.status == 'in_progress' %}bg-blue-500 text-white
                            {% elif booking.status == 'completed' %}bg-green-600 text-white
                            {% elif booking.status == 'cancelled' %}bg-red-600 text-white
                            {% endif %}">
                        {% if booking.status == 'pending' %}Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                        {% elif booking.status == 'assigned' %}ØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ†
                        {% elif booking.status == 'en_route' %}ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚
                        {% elif booking.status == 'arrived' %}ÙˆØµÙ„ Ø§Ù„Ù…ÙˆØ¸Ù
                        {% elif booking.status == 'in_progress' %}Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„
                        {% elif booking.status == 'completed' %}Ù…ÙƒØªÙ…Ù„
                        {% elif booking.status == 'cancelled' %}Ù…Ù„ØºÙŠ
                        {% endif %}
                    </span>

                    <!-- Cancel Button -->
                    {% if booking.status not in ['completed', 'cancelled'] %}
                    <form method="POST" action="{{ url_for('customer.cancel_booking', booking_id=booking.id) }}"
                        class="mt-3" onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ')">
                        <button type="submit"
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition">
                            <i class="fas fa-times mr-1"></i>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-primary p-12 rounded-lg shadow-lg text-center">
        <i class="fas fa-calendar-times text-6xl text-gray-500 mb-4"></i>
        <p class="text-xl text-gray-400 mb-6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª</p>
        <a href="{{ url_for('customer.book') }}"
            class="inline-block bg-accent hover:bg-blue-600 text-white px-8 py-3 rounded-lg font-bold transition">
            <i class="fas fa-plus mr-2"></i>Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}