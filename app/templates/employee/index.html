{% extends "base.html" %}

{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-white mb-2">{{ _('Welcome, %(username)s', username=current_user.username) }}</h2>
    <p class="text-gray-400">{{ _('Employee Dashboard') }}</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <a href="{{ url_for('employee.active_bookings') }}"
        class="bg-primary hover:bg-gray-700 p-6 rounded-lg shadow-lg transition">
        <div class="flex items-center justify-between mb-2">
            <i class="fas fa-calendar-check text-3xl text-blue-500"></i>
            <span class="text-3xl font-bold text-white">{{ active_bookings_count }}</span>
        </div>
        <h3 class="text-lg font-bold text-white">{{ _('Active Bookings') }}</h3>
        <p class="text-sm text-gray-400">{{ _('active booking') }}</p>
    </a>

    <a href="{{ url_for('employee.history') }}"
        class="bg-primary hover:bg-gray-700 p-6 rounded-lg shadow-lg transition">
        <div class="flex items-center justify-between mb-2">
            <i class="fas fa-history text-3xl text-green-500"></i>
            <span class="text-3xl font-bold text-white">{{ completed_today }}</span>
        </div>
        <h3 class="text-lg font-bold text-white">{{ _('History') }}</h3>
        <p class="text-sm text-gray-400">{{ _('Completed Today') }}</p>
    </a>

    <a href="{{ url_for('employee.stats') }}" class="bg-primary hover:bg-gray-700 p-6 rounded-lg shadow-lg transition">
        <div class="flex items-center justify-between mb-2">
            <i class="fas fa-chart-bar text-3xl text-accent"></i>
            <span><i class="fas fa-arrow-left text-white"></i></span>
        </div>
        <h3 class="text-lg font-bold text-white">{{ _('Statistics') }}</h3>
        <p class="text-sm text-gray-400">{{ _('Performance and Reports') }}</p>
    </a>

    <!-- Location Status Card -->
    <div class="bg-primary p-6 rounded-lg shadow-lg">
        <div class="flex items-center justify-between mb-2">
            <i class="fas fa-location-arrow text-3xl text-yellow-500"></i>
            <div id="gps-status-icon" class="w-3 h-3 rounded-full bg-gray-500"></div>
        </div>
        <h3 class="text-lg font-bold text-white">حالة الموقع</h3>
        <div class="text-sm text-gray-400 mt-2 space-y-1" dir="ltr">
            <p>Lat: <span id="debug-lat">-</span></p>
            <p>Lng: <span id="debug-lng">-</span></p>
            <p>Acc: <span id="debug-acc">-</span> m</p>
            <p>Msg: <span id="debug-msg">Waiting...</span></p>
        </div>
        <button onclick="forceUpdateLocation()"
            class="mt-3 w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-sm transition">
            تحديث الموقع الآن
        </button>
    </div>

    <script>
        function updateDebugInfo(lat, lng, acc, msg) {
            if (lat) document.getElementById('debug-lat').textContent = lat.toFixed(5);
            if (lng) document.getElementById('debug-lng').textContent = lng.toFixed(5);
            if (acc) {
                const el = document.getElementById('debug-acc');
                el.textContent = Math.round(acc);
                el.className = acc < 100 ? 'text-green-400 font-bold' : 'text-red-400 font-bold';
            }
            if (msg) document.getElementById('debug-msg').textContent = msg;
        }

        function forceUpdateLocation() {
            document.getElementById('debug-msg').textContent = "Updating...";
            if (!navigator.geolocation) {
                updateDebugInfo(null, null, null, "Geo not supported");
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const data = {
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude,
                        accuracy: pos.coords.accuracy
                    };
                    updateDebugInfo(data.latitude, data.longitude, data.accuracy, "Sending...");

                    fetch("{{ url_for('employee.update_location') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    })
                        .then(res => res.json())
                        .then(data => {
                            document.getElementById('debug-msg').textContent = "Sent OK";
                            document.getElementById('gps-status-icon').className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
                        })
                        .catch(err => {
                            document.getElementById('debug-msg').textContent = "Send Fail";
                        });
                },
                (err) => {
                    updateDebugInfo(null, null, null, `Error ${err.code}: ${err.message}`);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
    </script>
</div>
{% endblock %}