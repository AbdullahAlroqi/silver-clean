{% extends "admin/base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-white">تتبع مواقع الموظفين</h1>
            <p class="text-gray-400 text-sm mt-1">صفحة تجريبية - تحديث كل 30 ثانية</p>
        </div>
        <div class="flex items-center gap-4">
            <div id="lastUpdate" class="text-gray-400 text-sm"></div>
            <button onclick="refreshLocations()"
                class="bg-accent hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                <i class="fas fa-sync-alt ml-2"></i>تحديث
            </button>
        </div>
    </div>

    <!-- Map Container -->
    <div class="bg-primary rounded-xl overflow-hidden border border-gray-700">
        <div id="map" style="height: 600px; width: 100%;"></div>
    </div>

    <!-- Employee List -->
    <div class="bg-primary rounded-xl p-4 border border-gray-700">
        <h3 class="text-lg font-bold text-white mb-4">الموظفون المتصلون</h3>
        <div id="employeeList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <p class="text-gray-400">جاري التحميل...</p>
        </div>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    .employee-marker {
        background: #4DA8DA;
        border: 3px solid white;
        border-radius: 50%;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .employee-marker.inactive {
        background: #6B7280;
    }

    .leaflet-popup-content-wrapper {
        background: #303030;
        color: white;
        border-radius: 12px;
    }

    .leaflet-popup-tip {
        background: #303030;
    }
</style>

<script>
    // Initialize map centered on Saudi Arabia
    const map = L.map('map').setView([24.7136, 46.6753], 10);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Store markers
    let markers = {};

    // Custom icon
    function createIcon(isRecent) {
        return L.divIcon({
            className: 'employee-marker' + (isRecent ? '' : ' inactive'),
            iconSize: [20, 20],
            iconAnchor: [10, 10],
            popupAnchor: [0, -15]
        });
    }

    // Fetch and display employee locations
    async function refreshLocations() {
        try {
            const response = await fetch('/admin/api/employee-locations');
            const data = await response.json();

            // Clear old markers
            Object.values(markers).forEach(m => map.removeLayer(m));
            markers = {};

            // Update employee list
            const listEl = document.getElementById('employeeList');

            if (data.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400 col-span-full">لا يوجد موظفون متصلون حالياً</p>';
            } else {
                listEl.innerHTML = data.map(emp => `
                    <div class="bg-darkbg p-3 rounded-lg flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full ${emp.is_recent ? 'bg-green-500' : 'bg-gray-500'}"></div>
                        <div>
                            <p class="font-bold text-white">${emp.employee_name}</p>
                            <p class="text-xs text-gray-400">آخر تحديث: ${emp.updated_at || '-'}</p>
                        </div>
                        <button onclick="focusEmployee(${emp.latitude}, ${emp.longitude})" 
                                class="mr-auto text-accent hover:text-blue-400 transition">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                    </div>
                `).join('');

                // Add markers
                data.forEach(emp => {
                    const marker = L.marker([emp.latitude, emp.longitude], {
                        icon: createIcon(emp.is_recent)
                    }).addTo(map);

                    // Add accuracy circle if accuracy is available
                    if (emp.accuracy) {
                        const radius = emp.accuracy;
                        let color = '#22c55e'; // Green for high accuracy (< 100m)
                        if (radius > 1000) color = '#ef4444'; // Red for low accuracy (> 1000m)
                        else if (radius > 100) color = '#eab308'; // Yellow for medium

                        L.circle([emp.latitude, emp.longitude], {
                            radius: radius,
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.1,
                            weight: 1
                        }).addTo(map);
                    }

                    const accuracyText = emp.accuracy ?
                        (emp.accuracy > 1000 ?
                            `<span class="text-red-400 font-bold">⚠️ دقة منخفضة (${Math.round(emp.accuracy / 1000)} كم)</span>` :
                            `<span class="text-gray-400 text-xs">الدقة: ${Math.round(emp.accuracy)} متر</span>`)
                        : '';

                    marker.bindPopup(`
                        <div class="text-center p-2">
                            <p class="font-bold text-lg">${emp.employee_name}</p>
                            <p class="text-gray-400 text-sm">آخر تحديث: ${emp.updated_at || '-'}</p>
                            ${accuracyText}
                        </div>
                    `);

                    markers[emp.employee_id] = marker;
                });

                // Fit bounds if we have markers
                if (data.length > 0) {
                    const group = new L.featureGroup(Object.values(markers));
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            }

            // Update last refresh time
            document.getElementById('lastUpdate').textContent = 'آخر تحديث: ' + new Date().toLocaleTimeString('ar-SA');

        } catch (error) {
            console.error('Error fetching locations:', error);
        }
    }

    // Focus on specific employee
    function focusEmployee(lat, lng) {
        map.setView([lat, lng], 16);
    }

    // Initial load
    refreshLocations();

    // Auto-refresh every 30 seconds
    setInterval(refreshLocations, 30000);
</script>
{% endblock %}